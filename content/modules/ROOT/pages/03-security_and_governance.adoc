= Security and Governance


== Security & RBAC

* Each user is assigned a dedicated project in *OpenShift Dev Spaces* to host their workspaces.
* Projects can be assigned either automatically by *OpenShift Dev Spaces* or through the use of project templates to allow for more control and policy enforcement, as we will explore in upcoming labs.
* Each user is granted permissions only to their own project, meaning they cannot access other users’ resources.
* Administrators can set up granular access controls for different groups and users by adding the following configuration to the *OpenShift Dev Spaces Custom Resource (CRD)* :

```yaml
 networking:
    auth:
      advancedAuthorization:
        allowUsers:
          - user-a
          - user-b
        denyUsers:
          - user-c
        allowGroups:
          - team-a
          - team-b
        denyGroups:          
          - team-c
```

== Lab 3.1 Setup Granular Access

NOTE: Before proceeding with the lab instructions, you can watch this short video that provides a walkthrough of the steps to set up granular access.

video::03_1_Granular_Access.mp4[]

* In this lab, we will configure *granular access* to *OpenShift Dev Spaces*.
* We will create three new users in OpenShift, *Eddie*, *Ella* and *Marc*.
* We will allow access for users *admin*, *eddie* and *ella*, but not for *marc*, by adding the following configuration to the *CheCluster Custom Resource Definition (CRD)*:

```yaml
      advancedAuthorization:
        allowUsers:
          - admin
		  - eddie
		  - ella
```

---

=== Lab 3.1.1 Create new users

* Follow these commands to create new users using *htpasswd*: 

[source, role="execute"]
----
htpasswd -c -B -b new_users eddie openshift 
---- 

[source, role="execute"]
----
htpasswd -B -b new_users ella openshift
----

[source, role="execute"]
----
htpasswd -B -b new_users marc openshift 
----

---

* In your *OpenShift Console*, click on *Administration* in the left menu, then select *Cluster Setting*.
* Select the *Configuration* tab.
* Scroll down to select *OAuth*, then choose the *HTPASSWD* option.

image::oauth_httpwd.png[]

* Browse and select the *new_users* file you created.
* Finally, click the *Add* button.

image::add_users.png[]

--- 

=== Lab 3.1.2 Add configuration to CheCluster CRD

* Navigate back to the *Installed Operators*, and click on *Red Hat OpenShift Dev Spaces instance Specification* next to *Red Hat OpenShift Dev Spaces* operator.

image::select_provided_api.png[]

* Select the *devspaces* CheCluster.

image::select_checluster.png[]

* Switch to the *Yaml view* and add the following configuration: 

```yaml
      advancedAuthorization:
        allowUsers:
          - admin
		  - eddie
		  - ella
``` 

* Save your changes by clicking the *Save* button.
* Feel free to test your configuration using the three newly created users.

image::apply_granular_access.png[]

---

== Enforcing Polices

* *OpenShift Dev Spaces* is setup with a few policies by default that are designed to optimize the resource utilization of the CehCluster. Some of these policies includes:
** The maximum number of workspaces a user can run simultaneously.
** The total number of workspaces a user can maintain.
** The storage type used for workspaces, whether it’s per user, per workspace, or ephemeral.

=== Lab 3.2.1 Modify workspace policies

* Lets go ahead and modify the workspace polices by:
** Allowing two workspcaces to run simultaneously 
** Limiting the total number of workspaces to 4.
* In your terminal, execute the following command to allow two workspaces to run simultaneously:

[source, role="execute"]
----
oc patch checluster/devspaces -n openshift-operators \
--type='merge' -p \
'{"spec":{"devEnvironments":{"maxNumberOfRunningWorkspacesPerUser": 2}}}'
----

* Execute the following command to limit the number of workspaces to 5:

[source, role="execute"]
----
oc patch checluster/devspaces -n openshift-operators \
--type='merge' -p \
'{"spec":{"devEnvironments":{"maxNumberOfWorkspacesPerUser": 4}}}'
----

* Now, if you try to spin up a second workspace, OpenShift Dev Spaces will allow you to run it alongside your *Camel Project* workspace.
* However, if you return to your *Dashboard* and attempt to start a fifth workspace, *OpenShift Dev Spaces* will not allow it. 
* This time will not get the option to stop an existing workspace in order to start a new one, respecting the limit of 4 simultaneous workspaces that we’ve enforced.

NOTE: You can watch this short video to show those policies in action.

video::03_2_1_Enforcing_Policies.mp4[]

---

=== Lab 3.2.2 Modify storage policies

* The default storage policy in *OpenShift Dev Spaces* is set to *per user*, which is optimized for efficient usage of *Persistent Volume Claims (PVCs)* in *OpenShift*.
* However, *workspace isolation* may be desired for projects that require different environments or dependencies, as it prevents one workspace’s data from affecting another.
* This approach is especially beneficial for development workflows where multiple workspaces run different versions of software or frameworks that require distinct storage environments.
* Switching to a *per workspace* storage option means that each workspace will have its own *Persistent Volume Claim (PVC)* in OpenShift, providing better isolation and flexibility.
* To change the storage type, stop your workspace.
* In the *Overview* tab select *Storage Type* option, and change it to *per workspace*.

image::change_storage_type.png[]


---


=== Disable Auto Provisioning 

By default, OpenShift Dev Spaces will provision a unique <username>-devspaces project for each user. Alternatively, the cluster administrator can disable project self-provisioning on the OpenShift level, and turn off automatic namespace provisioning in the CheCluster custom resource:

devEnvironments:
  defaultNamespace:
    autoProvision: false

This setup allows achieving curated access to the Dev Spaces, where cluster administrators control provisioning for each user and can explicitly configure various settings including resource limits and quotas.


* PVC Strategy
* No of running wrokspaces
* Stop Autoprovisioning
* NaaS -> create onboarding project with project template